# Deployment Guide - Bespoke Ethos CRM Platform

Complete step-by-step guide for deploying the Bespoke Ethos CRM Platform to Vercel with Postgres database.

## Prerequisites

- GitHub account with repository access
- Vercel account (free tier works for development)
- Anthropic API key (get from [console.anthropic.com](https://console.anthropic.com))
- Node.js 18+ installed locally

## Deployment Methods

### Method 1: GitHub Integration (Recommended)

This method automatically deploys on every push to your main branch.

#### Step 1: Push Code to GitHub

```bash
# Initialize git if not already done
git init
git add .
git commit -m "Initial commit: Bespoke Ethos CRM Platform"

# Add remote and push
git remote add origin <your-github-repo-url>
git branch -M main
git push -u origin main
```

#### Step 2: Import to Vercel

1. Go to [vercel.com/new](https://vercel.com/new)
2. Click "Import Git Repository"
3. Select your GitHub repository
4. Configure project:
   - **Framework Preset**: Next.js (auto-detected)
   - **Root Directory**: `./` (leave as default)
   - **Build Command**: `next build` (auto-detected)
   - **Output Directory**: `.next` (auto-detected)

5. Click "Deploy" (we'll add environment variables next)

#### Step 3: Add Vercel Postgres Database

1. In your Vercel project dashboard, go to the "Storage" tab
2. Click "Create Database"
3. Select "Postgres"
4. Choose a database name (e.g., `bespoke-crm-db`)
5. Select region (choose closest to your users)
6. Click "Create"

Vercel automatically adds these environment variables to your project:
- `POSTGRES_URL`
- `POSTGRES_PRISMA_URL`
- `POSTGRES_URL_NON_POOLING`
- `POSTGRES_USER`
- `POSTGRES_HOST`
- `POSTGRES_PASSWORD`
- `POSTGRES_DATABASE`

#### Step 4: Configure Environment Variables

1. Go to Project Settings > Environment Variables
2. Add the following variables for **Production**, **Preview**, and **Development**:

**Required Variables:**

```
ANTHROPIC_API_KEY=sk-ant-api03-...
NEXTAUTH_SECRET=<generate-random-32-char-string>
NEXTAUTH_URL=https://your-domain.vercel.app
```

**Optional Variables:**

```
BLOB_READ_WRITE_TOKEN=<auto-generated-if-using-blob-storage>
```

**Generate NEXTAUTH_SECRET:**
```bash
openssl rand -base64 32
```

3. Click "Save" for each variable

#### Step 5: Run Database Migrations

**Option A: Using Vercel CLI (Recommended)**

```bash
# Install Vercel CLI
npm i -g vercel

# Login
vercel login

# Link to your project
vercel link

# Pull environment variables
vercel env pull .env.local

# Run migrations locally against production DB
npm run db:migrate

# Or run migration script directly
node scripts/migrate.js
```

**Option B: Using Vercel Dashboard**

1. Go to Project Settings > Functions
2. Add a one-time serverless function:

Create `app/api/migrate/route.ts`:
```typescript
import { sql } from '@vercel/postgres';
import { NextResponse } from 'next/server';

export async function GET(request: Request) {
  // Add authentication check here in production
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.MIGRATION_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  try {
    // Run your migrations here
    await sql`
      CREATE TABLE IF NOT EXISTS contacts (
        id SERIAL PRIMARY KEY,
        contact_name VARCHAR(255),
        title VARCHAR(255),
        company VARCHAR(255),
        company_website TEXT,
        linkedin_url TEXT,
        activity_level VARCHAR(50),
        top_skills TEXT,
        email VARCHAR(255) UNIQUE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      );
    `;

    return NextResponse.json({ success: true, message: 'Migration complete' });
  } catch (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
```

3. Add `MIGRATION_SECRET` to environment variables
4. Visit `https://your-domain.vercel.app/api/migrate` with auth header
5. Delete the migration route after completion

#### Step 6: Seed Database (Optional)

```bash
# Using local script with production DB connection
vercel env pull .env.local
npm run db:seed
```

Or create an API endpoint similar to the migration endpoint above.

#### Step 7: Verify Deployment

1. Visit your deployment URL: `https://your-project.vercel.app`
2. Check that the application loads
3. Test database connection by viewing contacts
4. Test Claude AI integration through the chat interface

### Method 2: Vercel CLI Deploy

For quick deployments without GitHub integration.

#### Step 1: Install Vercel CLI

```bash
npm i -g vercel
```

#### Step 2: Login to Vercel

```bash
vercel login
```

#### Step 3: Deploy

**First Deployment:**
```bash
vercel
```

This creates a preview deployment. Follow the prompts:
- Set up and deploy? **Y**
- Which scope? Select your account
- Link to existing project? **N**
- Project name? `bespoke-ethos-crm`
- Directory? `./`
- Override settings? **N**

**Production Deployment:**
```bash
vercel --prod
```

#### Step 4: Add Database and Environment Variables

Same as Steps 3-4 in Method 1.

## Post-Deployment Configuration

### 1. Custom Domain (Optional)

1. Go to Project Settings > Domains
2. Add your custom domain
3. Follow DNS configuration instructions
4. Update `NEXTAUTH_URL` to your custom domain

### 2. Configure Vercel Blob Storage (Optional)

For file uploads and attachments:

1. Go to Storage tab
2. Click "Create Database"
3. Select "Blob"
4. Vercel automatically adds `BLOB_READ_WRITE_TOKEN`

### 3. Set Up Monitoring

1. Go to Project Settings > Monitoring
2. Enable Web Analytics
3. Enable Speed Insights
4. Configure Error Tracking

### 4. Configure Security Headers

Add to `next.config.js`:

```javascript
module.exports = {
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'origin-when-cross-origin',
          },
        ],
      },
    ];
  },
};
```

## Environment-Specific Configurations

### Development Environment

```bash
# Pull production env vars to local
vercel env pull .env.local

# Or create .env.local manually with development values
POSTGRES_URL="postgres://localhost:5432/crm_dev"
ANTHROPIC_API_KEY="sk-ant-..."
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="dev-secret-32-chars"
```

### Preview Environment

Preview deployments (for PRs) automatically get production environment variables. To use different values:

1. Go to Environment Variables
2. Select "Preview" environment
3. Add preview-specific values

### Production Environment

Production uses the environment variables set in Vercel dashboard.

## Database Management

### Viewing Database Contents

**Using Vercel Dashboard:**
1. Go to Storage > Your Postgres Database
2. Click "Data" tab
3. Browse tables and data

**Using psql:**
```bash
# Get connection string from Vercel dashboard
psql "postgres://..."
```

**Using Drizzle Studio:**
```bash
npm run db:studio
```

### Running Migrations on Production

```bash
# Pull production environment variables
vercel env pull .env.production

# Run migrations against production
POSTGRES_URL=$PRODUCTION_POSTGRES_URL npm run db:migrate
```

### Database Backups

Vercel Postgres (powered by Neon) includes:
- Automatic daily backups
- Point-in-time recovery (Pro plan)
- Manual backup via dashboard

**Manual Backup:**
```bash
pg_dump "$(grep POSTGRES_URL .env.production | cut -d '=' -f2-)" > backup.sql
```

## Continuous Deployment

### Automatic Deployments

With GitHub integration:
- **Push to `main`** → Production deployment
- **Push to other branches** → Preview deployment
- **Pull Requests** → Preview deployment with unique URL

### Deploy Hooks

Create webhook for external triggers:

1. Go to Project Settings > Git
2. Click "Create Hook"
3. Name it (e.g., "Scheduled Deploy")
4. Use the webhook URL with:

```bash
curl -X POST https://api.vercel.com/v1/integrations/deploy/...
```

### GitHub Actions Integration (Optional)

Create `.github/workflows/deploy.yml`:

```yaml
name: Deploy to Vercel

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          vercel-args: '--prod'
```

## Troubleshooting

### Build Fails

**Issue:** Next.js build fails with TypeScript errors

**Solution:**
```bash
# Check locally first
npm run type-check
npm run build

# Fix errors, then push
```

### Database Connection Fails

**Issue:** Cannot connect to Postgres

**Solution:**
1. Verify environment variables are set
2. Check database is running in Vercel dashboard
3. Ensure connection pooling is enabled for serverless

### Edge Function Timeout

**Issue:** Claude AI requests timeout

**Solution:** Switch to Node.js runtime:
```typescript
// In your API route
export const runtime = 'nodejs';
export const maxDuration = 30; // seconds (Pro plan)
```

### Environment Variables Not Loading

**Issue:** Env vars undefined in production

**Solution:**
1. Redeploy after adding env vars
2. Check variable names match exactly (case-sensitive)
3. Ensure variables are set for correct environment

### Migration Failures

**Issue:** Migration script fails

**Solution:**
```bash
# Check connection
vercel env pull
psql "$POSTGRES_URL" -c "SELECT 1;"

# Run migrations with verbose logging
DEBUG=* npm run db:migrate
```

## Rollback Procedure

### Rollback to Previous Deployment

1. Go to Deployments tab
2. Find previous successful deployment
3. Click three dots > "Promote to Production"

### Rollback Database Changes

```bash
# If you have backups
psql "$POSTGRES_URL" < backup.sql

# Or use point-in-time recovery (Pro plan)
```

## Performance Optimization

### Enable Edge Caching

```typescript
// In page or route
export const revalidate = 60; // ISR: 60 seconds
```

### Use Edge Runtime

```typescript
export const runtime = 'edge'; // For fast, globally distributed responses
```

### Database Connection Pooling

Vercel Postgres automatically pools connections. Use `POSTGRES_URL` (pooled) for API routes.

## Security Checklist

- [ ] All environment variables secured in Vercel dashboard
- [ ] NEXTAUTH_SECRET is random and secure
- [ ] API routes have authentication checks
- [ ] Database has proper indexes
- [ ] CORS configured properly
- [ ] Rate limiting implemented
- [ ] Input validation on all endpoints
- [ ] SQL injection prevention (using parameterized queries)

## Monitoring & Alerts

### Set Up Alerts

1. Go to Project Settings > Monitoring
2. Configure alerts for:
   - Build failures
   - Runtime errors
   - High response times
   - Database connection issues

### View Logs

```bash
# Real-time logs
vercel logs

# Filter by function
vercel logs --follow
```

## Support Resources

- [Vercel Documentation](https://vercel.com/docs)
- [Vercel Postgres Guide](https://vercel.com/docs/storage/vercel-postgres)
- [Next.js Deployment](https://nextjs.org/docs/deployment)
- [Vercel Support](https://vercel.com/support)

## Cost Optimization

### Free Tier Limits
- 100 GB bandwidth
- 6,000 build minutes
- 100 GB-hours serverless function execution
- 256 MB Postgres storage
- 60 hours compute time

### Tips to Stay Under Limits
- Use ISR for frequently accessed pages
- Implement proper caching strategies
- Optimize images with Next.js Image component
- Use Edge functions where possible (cheaper than serverless)
- Monitor usage in Vercel dashboard

---

**Last Updated:** November 2025
**Platform Version:** Next.js 14+ on Vercel
